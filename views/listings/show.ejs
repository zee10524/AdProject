<% layout('layouts/boilerplate') %>

<div class="container mt-5">
<div class="row justify-content-center">
<div class="col-lg-8 col-md-10">

<!-- ================= HOTEL DETAILS ================= -->
<h2 class="mb-4 text-center fw-bold text-primary">
    üè® Hotel Details
</h2>

<div class="card shadow-lg border-0 mb-4">
    <img 
        src="<%= listing.image.url %>" 
        class="card-img-top"
        style="height:350px; object-fit:cover;"
    >

    <div class="card-body bg-light">

        <h3 class="fw-bold"><%= listing.title %></h3>

        <p class="text-muted">
            üë§ Listed by: 
            <%= listing.owner ? listing.owner.username : "Unknown" %>
        </p>

        <p class="fst-italic"><%= listing.description %></p>

        <hr>

        <ul class="list-group list-group-flush mb-3">

            <li class="list-group-item bg-transparent">
                <strong>Price:</strong>
                <span class="text-success fw-bold">
                    ‚Çπ<%= listing.price %>
                </span>
                <span class="badge bg-warning text-dark">per night</span>
            </li>

            <li class="list-group-item bg-transparent">
                <strong>Location:</strong>
                <%= listing.location %>, <%= listing.country %>
            </li>

            <li class="list-group-item bg-transparent">
                <strong>Max Guests:</strong>
                <%= listing.maxGuests %>
            </li>

            <li class="list-group-item bg-transparent">
                <strong>Rooms Available:</strong>
                <%= listing.roomsAvailable %>
            </li>

            <% if (listing.amenities && listing.amenities.length > 0) { %>
            <li class="list-group-item bg-transparent">
                <strong>Amenities:</strong>
                <ul class="mt-2">
                    <% listing.amenities.forEach(a => { %>
                        <li><%= a %></li>
                    <% }) %>
                </ul>
            </li>
            <% } %>

        </ul>

        <!-- OWNER CONTROLS -->
        <% if (
            currentUser &&
            listing.owner &&
            currentUser._id.equals(listing.owner._id)
        ) { %>

        <div class="d-flex gap-2">
            <a href="/listings/<%= listing._id %>/edit"
               class="btn btn-outline-primary flex-fill">
               ‚úè Edit
            </a>

            <form method="POST"
                  action="/listings/<%= listing._id %>?_method=DELETE"
                  class="flex-fill"
                  onsubmit="return confirm('Are you sure?');">

                <button class="btn btn-outline-danger w-100">
                    üóë Delete
                </button>
            </form>
        </div>

        <% } %>

    </div>
</div>

<!-- ================= BOOKING SECTION ================= -->
<hr>
<h4 class="mb-3 text-success">üìÖ Book This Hotel</h4>

<% if (currentUser) { %>

<form action="/listings/<%= listing._id %>/bookings"
      method="POST"
      class="row g-3 mb-4">

    <div class="col-md-4">
        <label>Check In</label>
        <input type="date"
               name="checkIn"
               class="form-control"
               required>
    </div>

    <div class="col-md-4">
        <label>Check Out</label>
        <input type="date"
               name="checkOut"
               class="form-control"
               required>
    </div>

    <div class="col-md-4">
        <label>Guests</label>
        <input type="number"
               name="guests"
               class="form-control"
               min="1"
               max="<%= listing.maxGuests %>"
               required>
    </div>

    <div class="col-12">
        <button class="btn btn-success w-100">
            Confirm Booking
        </button>
    </div>

</form>

<% } else { %>

<div class="alert alert-warning mb-4">
    Please <a href="/login">login</a> to book this hotel.
</div>

<% } %>

<!-- ================= REVIEW FORM ================= -->
<div class="card shadow border-0 mb-4">
<div class="card-body">

<h4 class="fw-semibold text-primary mb-3">
    ‚≠ê Leave a Review
</h4>

<% if (currentUser) { %>

<form action="/listings/<%= listing._id %>/reviews"
      method="POST"
      class="needs-validation"
      novalidate>

    <div class="mb-3">
        <label>Rating (1‚Äì5)</label>
        <input type="number"
               min="1"
               max="5"
               name="review[rating]"
               class="form-control"
               required>
    </div>

    <div class="mb-3">
        <label>Comment</label>
        <textarea name="review[comment]"
                  class="form-control"
                  rows="3"
                  required></textarea>
    </div>

    <button class="btn btn-dark w-100">
        Submit Review
    </button>

</form>

<% } else { %>

<div class="alert alert-warning">
    Please <a href="/login">login</a> to leave a review.
</div>

<% } %>

</div>
</div>

<!-- ================= ALL REVIEWS ================= -->
<h4 class="fw-bold mb-3">üìù All Reviews</h4>

<% if (listing.reviews && listing.reviews.length > 0) { %>

    <% listing.reviews.forEach((review) => { %>
    <div class="card shadow-sm mb-3">
        <div class="card-body">

            <p>
                <strong>Rating:</strong>
                <% for (let i = 1; i <= 5; i++) { %>
                    <% if (i <= review.rating) { %>
                        <span class="text-warning">‚òÖ</span>
                    <% } else { %>
                        <span class="text-secondary">‚òÜ</span>
                    <% } %>
                <% } %>
            </p>

            <p><%= review.comment %></p>

            <% if (review.author) { %>
                <small class="text-muted">
                    ‚Äî <%= review.author.username %>
                </small>
            <% } %>

            <% if (
                currentUser &&
                review.author &&
                currentUser._id.equals(review.author._id)
            ) { %>

                <form method="POST"
                      action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                      class="mt-2"
                      onsubmit="return confirm('Delete review?');">

                    <button class="btn btn-sm btn-danger">
                        Delete Review
                    </button>
                </form>

            <% } %>

        </div>
    </div>
    <% }) %>

<% } else { %>

<div class="alert alert-info">
    No reviews yet. Be the first!
</div>

<% } %>

<!-- ================= BACK BUTTON ================= -->
<div class="text-center mt-4">
    <a href="/listings"
       class="btn btn-secondary">
       ‚Üê Back to Listings
    </a>
</div>

</div>
</div>
</div>
